# ncm-inject

塞壬唱片桌面版 - 网易云音乐注入实现

直接查询用户公开歌单了，问就是架构不合理导致的

启动进程时可通过 `NETEASE_USER_UID` 设置 UID，也可以通过请求接口的方式设置和查询当前 UID

假如需要会员听歌可能还是需要做登录，可能会在软件内用 iframe 嵌入登录页面

该插件影响如下：

- 操作全局 store
  - 改变歌曲列表
    因网易云无法确定当前用户有多少歌曲，所以在每次选择播放网易云音乐时将要改变全局播放列表以保证页面正常运行

    该插件的 `get_songs` 方法将永远返回空数组

打包通过 esbuild 实现，dist-node 文件夹下放置 node 打包结果，dist-browser 文件夹下放置 react 编译代码

最后结果则是进行 rust dll 打包，放入 dist 下

## 实现登录？

这个也不是没办法解决，而且可以处理很多歌听不了的情况

计划是在 localhost:53753 开放一个登录页面，在这个页面直接进行登录操作

但是目前 (2024/07/24) 尝试登录后请求 `song/url` 仍然没办法获取音频链接，不知道是不是参数搞错了还是啥情况，如果有知道的大佬可以开 isuue 说一下

## 为什么很多歌听不了

目前 (2024/07/24) 网易云更新了 `song/url` 及其 `v1` 接口，且 `NeteaseCloudMusicApi` `4.22.0` 版本在请求该接口时会出现 -460

插件内使用的是 `/song/download/url` 来获取音频链接，遇到 vip 下载的歌曲基本上都没法获取音频链接

解决方法是以匿名身份直接在浏览器进入网易云页面，在播放歌曲后获取 cookie，并在请求参数附带他；目前**不知道**这种匿名用户 cookie 的是否长期有效，但是使用这种 cookie 能使得错误 -460 转为正常请求并获取歌曲数据。
